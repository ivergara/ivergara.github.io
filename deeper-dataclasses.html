<!DOCTYPE html>
<html lang="en">
<head>
    <title>Deeper into dataclasses - On data, programming, and technology</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://ivergara.github.io/deeper-dataclasses.html">

        <meta name="author" content="Ignacio Vergara Kausel" />
        <meta name="keywords" content="dataclasses,code quality,intermediate" />
        <meta name="description" content="Most articles cover the basics of dataclasses, this is an attempt to cover some more advanced features of this module." />




    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://ivergara.github.io/theme/css/bootstrap.cosmo.min.css" type="text/css"/>
    <link href="https://ivergara.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://ivergara.github.io/theme/css/pygments/manni.css" rel="stylesheet">
        <link href="https://ivergara.github.io/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ivergara.github.io/theme/css/style.css" type="text/css"/>

        <link href="https://ivergara.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="On data, programming, and technology ATOM Feed"/>

        <link href="https://ivergara.github.io/feeds/python-dataclasses.atom.xml" type="application/atom+xml" rel="alternate"
              title="On data, programming, and technology Python, dataclasses ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://ivergara.github.io/" class="navbar-brand">
On data, programming, and technology            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://ivergara.github.io/pages/about-me.html">
                             about&nbsp;me
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://ivergara.github.io/deeper-dataclasses.html"
                       rel="bookmark"
                       title="Permalink to Deeper into dataclasses">
                        Deeper into&nbsp;dataclasses
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2019-08-05T12:20:00+02:00"> Mon 05 August 2019</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://ivergara.github.io/tag/dataclasses.html">dataclasses</a>
        /
	<a href="https://ivergara.github.io/tag/code-quality.html">code quality</a>
        /
	<a href="https://ivergara.github.io/tag/intermediate.html">intermediate</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Usually, examples using the <code>dataclasses</code> module in Python are rather simple in the use of its features. That by itself is completely fine, but sometimes the implementation can be very tedious and cumbersome. However, the <code>dataclasses</code> module offers ways to be smarter, which are rarely talked about. With this article, I want to change that. Thus, this article doesn&#8217;t cover topics like when and how to use them. There is plenty of material on the Internet to learn about&nbsp;that.</p>
<p>The following code represents a 3D point which can be added to another point and multiplied by a number element-wise. (Note: this makes this object more akin to a vector in my view). An extra feature is that it also supports iteration and unpacking via the <code>__iter__</code> method, making the point and a number <a href="https://en.wikipedia.org/wiki/Commutative_property">commutative</a>.</p>
<div class="highlight"><pre><span></span><span class="c1"># Baseline solution</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">astuple</span><span class="p">,</span> <span class="n">dataclass</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">,</span> <span class="n">z1</span><span class="o">+</span><span class="n">z2</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="o">-</span><span class="n">y2</span><span class="p">,</span> <span class="n">z1</span><span class="o">-</span><span class="n">z2</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="n">scalar</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">scalar</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">scalar</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalar</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>   
</pre></div>


<p>This is a good implementation, but even when using the fact that the point can be unpacked, it is quite tedious and repetitive. Typing <code>x1, y1, z1 = self</code> for every method is less than ideal. Also, what if we want to also have points in 2D, 4D or 6D? Well, that&#8217;s straightforward but error-prone. We have to add/delete attributes/fields definitions and all references to them in the relevant methods. In this particular case, that would be six lines modified. The first part is the easy and the second one (very) annoying. We could do slightly better and only having to care for the first part if we want to address other&nbsp;dimensions.</p>
<h2>Using <code>dataclasses</code> introspection</h2>
<p>Let&#8217;s be slightly smarter and use more of the tools available in the <code>dataclasses</code> module. In particular, the function <code>fields()</code> which exposes the fields defined in a <code>dataclass</code>. Thus, instead of having to name each coordinate of the point in the different operation methods, we can iterate over&nbsp;them.</p>
<div class="highlight"><pre><span></span><span class="c1"># Introspection based solution</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">astuple</span><span class="p">,</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">fields</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">-</span><span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">*</span><span class="n">other</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</pre></div>


<p>To understand how it works, I will focus on the <code>__add__</code> method. There is quite a bit to unpack. At the core is the call to <code>fields()</code> function, which returns a tuple of 3 <code>field</code> objects, a <code>field</code> object being how a <code>dataclass</code> represents an attribute. You can (and should) go and check it out in a <span class="caps">REPL</span>, this can be done on the class itself or an instance of it. Since we have a tuple, we can iterate over it and access the name of each&nbsp;attribute.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="n">Point</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">x</span>
<span class="n">y</span>
<span class="n">z</span>
</pre></div>


<p>Then, the next step is to use this to get the values associated with each attribute from the instance as&nbsp;follows</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span><span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</pre></div>


<p>Now we can do the operation between the two point instances that are being operated, and we unpack the generator expression into the arguments of the <code>Point</code> initialization </p>
<div class="highlight"><pre><span></span><span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</pre></div>


<p>The last step is to put this as the return value of the <code>__add__</code> method and then to implement the same strategy for the other methods. With this, we achieved the first step in removing the annoyance of having to touch every method if we change the number of dimensions of the point class. As a bonus, we also got to reduce the total amount of lines of code involved&nbsp;slightly.</p>
<h2>An alternative&nbsp;solution</h2>
<p>I have to agree that using this level of introspection of a <code>dataclass</code> might be a bit cumbersome, particularly by the use of the <code>getattr</code> function. This would be the solution if we weren&#8217;t implementing the <code>__iter__</code> method. But since we&#8217;re supporting the iterator protocol, we can do something that perhaps is smarter. Thus, instead of having to iterate over the defined fields, we can iterate over the point object&nbsp;itself!</p>
<div class="highlight"><pre><span></span><span class="c1"># Iterator based solution</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">astuple</span><span class="p">,</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">fields</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="o">*</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="o">*</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</pre></div>


<p>To highlight the pivotal piece that the <code>__iter__</code> method plays in this solution, I moved it to the top. For the rest, the code should be pretty much self-explanatory. I&#8217;d say that the use of the functions defined in the <code>operator</code> module also makes the code&nbsp;clearer.</p>
<h2>Code quality&nbsp;metrics</h2>
<p>Lately, I&#8217;ve also been tangentially interested in code quality metrics. I have a hypothesis regarding the standard metrics to quantify code quality, namely, that they are not well-tailored for dynamic languages like Python. In particular with features like&nbsp;decorators.</p>
<p>Let&#8217;s explore some statistics for the three solutions covered before plus a solution without using <code>dataclasses</code> (classic) which is not shown but easy to get from the naive dataclass based&nbsp;solution. </p>
<table>
<thead>
<tr>
<th></th>
<th><span class="caps">SLOC</span></th>
<th><span class="caps">MI</span></th>
<th>Rank</th>
</tr>
</thead>
<tbody>
<tr>
<td>Classic</td>
<td>24</td>
<td>53.41</td>
<td>A</td>
</tr>
<tr>
<td>Baseline</td>
<td>21</td>
<td>54.28</td>
<td>A</td>
</tr>
<tr>
<td>Introspection</td>
<td>16</td>
<td>60.22</td>
<td>A</td>
</tr>
<tr>
<td>Iterator</td>
<td>17</td>
<td>100</td>
<td>A</td>
</tr>
</tbody>
</table>
<p>Without diving too deep, the maintainability index increases as we move through the different implementations. This result was something that I intuitively expected. What it&#8217;s shocking is the value of 100 for the iterator based solution. This warrants a deeper dive into this later on, as it seems unlikely it&#8217;s a bug in the <code>radon</code> library and right now I&#8217;m too ignorant about this topic to be able to have an idea why this is the&nbsp;case.</p>
<p>Somehow I would have expected a more significant step between the classic and baseline dataclass solutions. But given that the methods we do implement are the same and the ones we didn&#8217;t have to write (<code>__init__</code>, <code>__eq__</code>, <code>__repr__</code>) are rather simple it is understandable that they don&#8217;t differ&nbsp;much.</p>
<h2>Performance</h2>
<p>Using <code>%timeit</code> on my laptop, I ran a quick benchmark of the addition of two&nbsp;points</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">Point3D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">Point3D</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">p1</span><span class="o">+</span><span class="n">p2</span>
</pre></div>


<p>for the three solutions implemented in this article, with the following&nbsp;results</p>
<table>
<thead>
<tr>
<th></th>
<th>mean (µs)</th>
<th>std</th>
</tr>
</thead>
<tbody>
<tr>
<td>Baseline</td>
<td>33</td>
<td>5.18 µs</td>
</tr>
<tr>
<td>Introspection</td>
<td>6.04</td>
<td>450 ns</td>
</tr>
<tr>
<td>Iterator</td>
<td>30.4</td>
<td>3.34 µs</td>
</tr>
</tbody>
</table>
<p>We can say that the introspection based solution is considerably more performant than the other two. Would be interesting to understand better where the win (loses) for the introspection (iterator) based solution come&nbsp;from.</p>
<p>In any case, this example shows something interesting, we can increase the maintainability index while also increasing the performance. This fact is not necessarily a given, as usually performance comes at the cost of&nbsp;readability. </p>
<h2>What about nD&nbsp;points?</h2>
<p>But the situation could still be improved. Let&#8217;s say you want to be able to have 2D and 3D point living along. We could copy and paste the whole definition, give each class a different name, and be sure to have the correct number of attributes. But that&#8217;d be extremely silly and we could (and should) use inheritance (see the <a href="https://ivergara.github.io/ABC-and-dataclasses.html">previous post</a> which explores abstract base classes and dataclasses) and reuse all the code for the operations since we just made them independent of the dimension the point lives in. Since we&#8217;re exploring <code>dataclasses</code>, I&#8217;ll return to the first&nbsp;solution.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">astuple</span><span class="p">,</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">fields</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BasePoint</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">-</span><span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">*</span><span class="n">other</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Point2D</span><span class="p">(</span><span class="n">BasePoint</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Point3D</span><span class="p">(</span><span class="n">BasePoint</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span>
</pre></div>


<p>Excellent, we have now points in any dimension we want with little&nbsp;effort!</p>
<h2>A factory of&nbsp;points</h2>
<p>But is there a way to make even less work than this? The <code>dataclasses</code> module has a nifty function called <code>make_dataclass</code> which, as its name says, makes dataclasses based on its&nbsp;arguments.</p>
<p>We can try and create a point in&nbsp;1D</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">Point1D</span> <span class="o">=</span> <span class="n">make_dataclass</span><span class="p">(</span><span class="s1">&#39;Point1D&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">)],</span> <span class="n">bases</span><span class="o">=</span><span class="p">(</span><span class="n">BasePoint</span><span class="p">,))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Point1D</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Point1D</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>Compared to defining the class in a normal way this doesn&#8217;t seem to be a big win. But what if we want to create an exotic point in 5 dimensions? Well, first we create a list of tuples with the field names and types and then we use <code>make_dataclass</code> with&nbsp;it.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">dims</span> <span class="o">=</span> <span class="mi">5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">fields_definition</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span><span class="s1">&#39;x{i}&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dims</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Point5D</span> <span class="o">=</span> <span class="n">make_dataclass</span><span class="p">(</span><span class="s1">&#39;Point5D&#39;</span><span class="p">,</span> <span class="n">fields_definition</span><span class="p">,</span> <span class="n">bases</span><span class="o">=</span><span class="p">(</span><span class="n">BasePoint</span><span class="p">,))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Point5D</span><span class="p">(</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">Point5D</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">x3</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">x4</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>


<p>I move from the naming <code>xyz</code> to <code>x{i}</code> in a more &#8220;mathematical&#8221; notation which for computers also works much&nbsp;better.</p>
<p>This sets the stage up to create a whole family of points. For this we create a function which will create them (a&nbsp;Factory)</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">PointFactory</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
     <span class="n">fields_definition</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span><span class="s1">&#39;x{i}&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">make_dataclass</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Point{dims}D&#39;</span><span class="p">,</span> <span class="n">fields_definition</span><span class="p">,</span> <span class="n">bases</span><span class="o">=</span><span class="p">(</span><span class="n">BasePoint</span><span class="p">,))</span>
</pre></div>


<p>Making use of this factory a series of classes representing points in different dimensions can be easily&nbsp;created</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">point_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">PointFactory</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">point_classes</span>
<span class="p">[</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">abc</span><span class="o">.</span><span class="n">Point0D</span><span class="s1">&#39;&gt;, &lt;class &#39;</span><span class="n">abc</span><span class="o">.</span><span class="n">Point1D</span><span class="s1">&#39;&gt;, &lt;class &#39;</span><span class="n">abc</span><span class="o">.</span><span class="n">Point2D</span><span class="s1">&#39;&gt;, &lt;class &#39;</span><span class="n">abc</span><span class="o">.</span><span class="n">Point3D</span><span class="s1">&#39;&gt;, &lt;class &#39;</span><span class="n">abc</span><span class="o">.</span><span class="n">Point4D</span><span class="s1">&#39;&gt;]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">point_classes</span><span class="p">[</span><span class="mi">3</span><span class="p">](</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">Point3D</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>


<h2>Conclusion</h2>
<p>Besides the boilerplate reduction that the <code>dataclasses</code> module provides, it offers some powerful tooling to work with them. As an example, I showed how to create a factory of n-dimensional&nbsp;points.</p>
<p>Moreover, I discovered that using the introspection machinery of <code>dataclasses</code> leads to a higher performant code. Not that this was a goal of this article, but it&#8217;s always nice to get a boost. Keep in mind that <strong>introspection</strong>, in this case, might be a slightly wrong term, as it would make people believe it should be less performant, particularly those coming from&nbsp;Go.</p>
<p>After seeing the performance of each implementation, the question arises if the iterator based could be improved by being smarter. At least my first exploratory attempt by moving from <code>import operator</code> to <code>from operator import add, mul, sub</code> did not show any change. Perhaps this would be a good exercise for the reader&nbsp;;)</p>
<h3>Acknowledgments</h3>
<p>I want to thank Nour Faroua for her contribution leading to simplification on the code, and to Bryan Reynaert for his thorough review and input improving organization, explanations, and language of the&nbsp;article.</p>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'on-data-programming-and-technology'; // required: replace example with your forum shortname

            var disqus_config = function () {
                this.language = "en";

                        this.page.identifier = '2019-08-05-deeper-dataclasses';
                        this.page.url = 'https://ivergara.github.io/deeper-dataclasses.html';
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="http://twitter.com/ivergarak"><i class="fa fa-twitter-square fa-lg"></i> twitter</a></li>
    <li class="list-group-item"><a href="https://www.linkedin.com/in/ignaciovergara/"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="http://github.com/ivergara"><i class="fa fa-github-square fa-lg"></i> github</a></li>
    <li class="list-group-item"><a href="https://stackoverflow.com/users/2244081/ignacio-vergara-kausel"><i class="fa fa-stack-overflow fa-lg"></i> stackoverflow</a></li>
    <li class="list-group-item"><a href="https://ivergara.github.io/feeds/all.atom.xml"><i class="fa fa-rss-square fa-lg"></i> rss</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2019 Ignacio Vergara Kausel
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://ivergara.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://ivergara.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://ivergara.github.io/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'on-data-programming-and-technology'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-109035444-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->


</body>
</html>